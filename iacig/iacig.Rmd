---
title: "Summary Statistics: Establishing Monarch Butterfly Breeding Habitat on Iowa Swine Production Sites"
author: "Jarad Niemi, Seth Appelgate, and Nehemias Ulloa"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{fullpage}
  - \usepackage{rotating}
  - \usepackage{caption} 
  - \captionsetup[table]{skip=10pt}
output: 
  pdf_document:
    fig_caption: TRUE
---

```{r setup, purl=FALSE, echo=FALSE}
draft = FALSE

library("knitr")
opts_chunk$set(echo     = draft, 
               results  = 'asis',
               message  = draft,
               warnings = draft,
               cache    = TRUE)
```

```{r packages}
library("tidyverse")
library("ISUmonarch")
library("xtable")
options(xtable.comment = FALSE)
```

```{r sessionInfo, results='markup', eval=draft}
sessionInfo()
```

```{r palette, cache=TRUE}
ISU_primary_palette   <- c("#C8102E", "#F1BE48", "#524727", 
                           "#9B945F", "#CAC7A7")

ISU_secondary_palette <- c("#3E4827", "#76881D", "#A2A569",
                           "#003D4C", "#006BA6", "#7A99AC",
                           "#7C2529", "#9A3324", "#BE531C",
                           "#8B5B29", "#B9975B", "#EED484",
                           "#6E6259", "#707372", "#ACA39A")

####################################################################

month_col <- c("June"   = ISU_primary_palette[3], 
               "July"   = ISU_primary_palette[2],
               "August" = ISU_primary_palette[1])

class_col <- c("Forbs"             = ISU_secondary_palette[4],
               "Milkweed"          = ISU_secondary_palette[3],
               "Warm season grass" = ISU_secondary_palette[1],
               "Cool season grass" = ISU_secondary_palette[2],
               "Woody plants"      = ISU_secondary_palette[11],
               "Bare ground"       = ISU_secondary_palette[10])

```

\setlength{\tabcolsep}{3pt}


```{r sites, cache=TRUE}
sites = unique(transect %>% 
                      filter(grant=="iacig") %>%
                      filter(siteID %in% c("byd1","byd2","cra1","uth3")) %>%
                      pull(siteID) %>% as.character())
```


# Robel

```{r robel_data, dependson="sites"}
d <- robel %>% 
  filter(siteID %in% sites) %>%
  select(siteID, year, month, height, censored) %>%
  mutate(Month = recode(month, `6` = "June", `7` = "July", `8` = "August"),
         Month = factor(Month, levels = c("June","July","August")))

stopifnot(all(d$censored == "not"))
```


```{r robel_monthly, dependson="robel_data"}
s <- d %>%
  group_by(year, siteID, Month) %>%
  summarize(height = mean(height))
```

```{r, robel_monthly_plot, dependson=c("robel_monthly","palette")}
g_monthly <- ggplot(s, aes(year, height, 
              linetype = Month, 
              group = Month,
              color = Month)) +
  geom_line() + 
  facet_wrap(~siteID) + 
  labs(x = "Year", y = "Height (cm)", title="Mean Robel Heights by Month") + 
  theme_bw() + 
  theme(legend.position = "bottom") +
  scale_color_manual(values = month_col)

g_monthly
```



```{r robel_yearly, dependson="robel_data"}
s_yearly <- d %>%
  group_by(year, siteID) %>%
  summarize(height = mean(height))
```

```{r robel_yearly_table, dependson="robel_yearly"}
tab_yearly <- s_yearly %>% 
  spread(year, height) %>%
  xtable(
    align = "ll|rrrr",
    caption = "Mean Robel heights",
    digits = 1) 

tab_yearly
```

```{r robel_yearly_plot, dependson=c("robel_yearly","palette")}
g_yearly <- ggplot(s_yearly, aes(year, height)) +
  geom_line() + 
  facet_wrap(~siteID) + 
  labs(x = "Year", 
       y = "Height (cm)",
       title = "Mean Robel Heights") + 
  theme_bw() +
  theme(legend.position = "bottom") 

g_yearly
```


```{r robel_write_tables, dependson="robel_yearly_table"}
tab_yearly %>%
  print(
    file = "include/robel_yearly.tex",
    include.rownames = FALSE)
```

```{r robel_write_plots, dependson="robel_monthly_plot"}
ggsave(plot = g_monthly,
       filename = "include/robel_monthly.png")

ggsave(plot = g_yearly,
       filename = "include/robel_yearly.png",
       width = 6, height = 4)
```




\clearpage
# Daubenmire

```{r daubenmire_data}
d <- cover %>% 
  filter(siteID %in% sites) %>%
  select(siteID, year, month, section, class, percentage) %>%
  mutate(month = recode(month, `6` = "June", `7` = "July", `8` = "August"),
         month = factor(month, levels = c("June","July","August"))) %>%
  filter(class %in% c("bare_ground","csg","forbs","milkweed","wsg","woody_species"))
```


```{r daubenmire_yearly, dependson="daubenmire_data"}
s <- d %>%
  group_by(year, siteID, class) %>%
  summarize(percentage = mean(percentage)) %>%
  ungroup() %>%
  mutate(class = recode(class,
                        bare_ground   = "Bare ground",
                        csg           = "Cool season grass",
                        wsg           = "Warm season grass",
                        milkweed      = "Milkweed",
                        woody_species = "Woody plants",
                        forbs         = "Forbs"),
         class = factor(class, 
                        levels = c("Forbs",
                                   "Milkweed",
                                   "Warm season grass",
                                   "Cool season grass",
                                   "Woody plants",
                                   "Bare ground")))
```


```{r daubenmire_yearly_table, dependson="daubenmire_yearly"}
ss <- s %>%
  # Create table by ordering columns by class and then year
  arrange(siteID, class, year) %>%
  mutate(column = factor(paste(class, year, sep="@"),
                         levels = unique(paste(class, year, sep="@")))) %>%
  select(siteID, column, percentage) %>%
  tidyr::spread(column, percentage, fill=NA) 

# Fix column names and create additional row
nc <- ncol(ss)
tmp <- data.frame(nms = names(ss)[-1]) %>%
  tidyr::separate(nms, into=c("row1", "row2"), sep="@")
names(ss)[-1] <- tmp$row2
new_row <- paste(" & \\multicolumn{4}{c|}{",unique(tmp$row1),"}", 
                 collapse="")
new_row <- gsub("_", " ", new_row)
new_row <- paste(new_row, "\\\\", collapse=" ")

# Write table to file
tab <- ss %>%
  xtable(
    digits = 0,
    align = paste("rr|",paste(rep("rrrr|",floor(nc/4)),collapse=""),sep="",collapse=""),
    caption="Daubenmire: average land cover \\% across all rounds Caption 1234",
    label = "t:daubenmire") 

tab
```

```{r daubenmire_write_table, dependson="daubenmire_table"}
tab %>%
  print(
    file = "include/daubenmire.tex",
    include.rownames = FALSE, 
    # NA.string="na",
    add.to.row = list(pos = list(-1), 
                      command = new_row),
    caption.placement = "top",
    size="\\small",
    floating.environment = "sidewaystable",
    hline.after = c(-1,0,4)
    ) 
```


```{r daubenmire_yearly_plot, dependson=c("daubenmire_yearly","palette")}
g_yearly <- ggplot(s, aes(year, percentage)) +
  geom_line() + 
  facet_grid(class ~ siteID, scales = "free_y") + 
  labs(x = "Year", y = "Mean Cover (%)") +
  theme_bw() + 
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle=90))

g_yearly
```


```{r daubenmire_yearly_plot_by_class, dependson=c("daubenmire_yearly","palette"), fig.height=8}
g_yearly_by_class <- ggplot(s, aes(year, percentage,
                   fill = class, 
                   # linetype = class, 
                   group = class)) +
  geom_area(color="white") + 
  facet_grid(siteID ~ .) +
  labs(x = "Year", y = "Mean Cover (%)") +
  scale_fill_manual(values = class_col) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle=90))

g_yearly_by_class
```


```{r daubenmire_write_plots, dependson=c("daubenmire_yearly_plot","daubenmire_yearly_plot_by_class")}
ggsave(filename = "include/daubenmire_yearly.png",
       plot = g_yearly,
       width = 6, 
       height = 4)

ggsave(filename = "include/daubenmire_yearly_by_class.png",
       plot = g_yearly_by_class,
       width = 6, 
       height = 6)
```






