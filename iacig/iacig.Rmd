---
title: "Summary Statistics: Establishing Monarch Butterfly Breeding Habitat on Iowa Swine Production Sites"
author: "Jarad Niemi, Seth Appelgate, and Nehemias Ulloa"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{fullpage}
  - \usepackage{rotating}
  - \usepackage{caption} 
  - \captionsetup[table]{skip=10pt}
output: 
  pdf_document:
    fig_caption: TRUE
---

```{r setup, purl=FALSE, echo=FALSE}
draft = FALSE

library("knitr")
opts_chunk$set(echo     = draft, 
               results  = 'asis',
               message  = draft,
               warnings = draft,
               cache    = TRUE)
```

```{r packages}
library("tidyverse")
library("ISUmonarch")
library("xtable")
options(xtable.comment = FALSE)
```

```{r sessionInfo, results='markup', eval=draft}
sessionInfo()
```

```{r palette, cache=TRUE}
ISU_primary_palette   <- c("#C8102E", "#F1BE48", "#524727", 
                           "#9B945F", "#CAC7A7")

ISU_secondary_palette <- c("#3E4827", "#76881D", "#A2A569",
                           "#003D4C", "#006BA6", "#7A99AC",
                           "#7C2529", "#9A3324", "#BE531C",
                           "#8B5B29", "#B9975B", "#EED484",
                           "#6E6259", "#707372", "#ACA39A")

####################################################################

month_col <- c("June"   = ISU_primary_palette[3], 
               "July"   = ISU_primary_palette[2],
               "August" = ISU_primary_palette[1])

class_col <- c("Forbs"             = ISU_secondary_palette[4],
               "Milkweed"          = ISU_secondary_palette[9],
               "Warm season grass" = ISU_secondary_palette[1],
               "Cool season grass" = ISU_secondary_palette[2],
               "Woody plants"      = ISU_secondary_palette[11],
               "Bare ground"       = ISU_secondary_palette[10])

```

\setlength{\tabcolsep}{3pt}


```{r sites, cache=TRUE}
sites = unique(transect %>% 
                      filter(grant=="iacig") %>%
                      filter(siteID %in% c("byd1","byd2","cra1","uth3")) %>%
                      pull(siteID) %>% as.character())
```


# Robel

```{r robel_data, dependson="sites"}
d <- robel %>% 
  filter(siteID %in% sites) %>%
  select(siteID, year, month, height, censored) %>%
  mutate(Month = recode(month, `6` = "June", `7` = "July", `8` = "August"),
         Month = factor(Month, levels = c("June","July","August")))

stopifnot(all(d$censored == "not"))
```


```{r robel_monthly, dependson="robel_data"}
s <- d %>%
  group_by(year, siteID, Month) %>%
  summarize(height = mean(height))
```

```{r, robel_monthly_plot, dependson=c("robel_monthly","palette"),fig.cap="Robel heights by month caption"}
g_monthly <- ggplot(s, aes(year, height, 
              linetype = Month, 
              group = Month,
              color = Month)) +
  geom_line() + 
  facet_wrap(~siteID) + 
  labs(x = "Year", y = "Height (cm)", title="Mean Robel Heights by Month") + 
  theme_bw() + 
  theme(legend.position = "bottom") +
  scale_color_manual(values = month_col)

g_monthly
```



```{r robel_yearly, dependson="robel_data"}
s_yearly <- d %>%
  group_by(year, siteID) %>%
  summarize(height = mean(height))
```

```{r robel_yearly_table, dependson="robel_yearly"}
tab_yearly <- s_yearly %>% 
  spread(year, height) %>%
  xtable(
    align = "ll|rrrr",
    caption = "Mean Robel heights",
    digits = 1) %>%
  print(
    # file = "include/robel_yearly.tex",
    caption.placement = "top",
    include.rownames = FALSE,
    comment = FALSE)
```

```{r robel_yearly_plot, dependson=c("robel_yearly","palette"),fig.cap="Robel heights by year caption"}
g_yearly <- ggplot(s_yearly, aes(year, height)) +
  geom_line() + 
  facet_wrap(~siteID) + 
  labs(x = "Year", 
       y = "Height (cm)",
       title = "Mean Robel Heights") + 
  theme_bw() +
  theme(legend.position = "bottom") 

g_yearly
```



```{r robel_write_plots, dependson="robel_monthly_plot"}
ggsave(plot = g_monthly,
       filename = "include/robel_monthly.png")

ggsave(plot = g_yearly,
       filename = "include/robel_yearly.png",
       width = 6, height = 4)
```




\clearpage
# Daubenmire

```{r daubenmire_data}
d <- cover %>% 
  filter(siteID %in% sites) %>%
  select(siteID, year, month, section, class, percentage) %>%
  mutate(month = recode(month, `6` = "June", `7` = "July", `8` = "August"),
         month = factor(month, levels = c("June","July","August"))) %>%
  filter(class %in% c("bare_ground","csg","forbs","milkweed","wsg","woody_species"))
```


```{r daubenmire_yearly, dependson="daubenmire_data"}
s <- d %>%
  group_by(year, siteID, class) %>%
  summarize(percentage = mean(percentage)) %>%
  ungroup() %>%
  mutate(class = recode(class,
                        bare_ground   = "Bare ground",
                        csg           = "Cool season grass",
                        wsg           = "Warm season grass",
                        milkweed      = "Milkweed",
                        woody_species = "Woody plants",
                        forbs         = "Forbs"),
         class = factor(class, 
                        levels = c("Forbs",
                                   "Milkweed",
                                   "Warm season grass",
                                   "Cool season grass",
                                   "Woody plants",
                                   "Bare ground")))
```


```{r daubenmire_yearly_table, dependson="daubenmire_yearly"}
# ss <- s %>%
#   # Create table by ordering columns by class and then year
#   arrange(siteID, class, year) %>%
#   mutate(column = factor(paste(class, year, sep="@"),
#                          levels = unique(paste(class, year, sep="@")))) %>%
#   select(siteID, column, percentage) %>%
#   tidyr::spread(column, percentage, fill=NA) 

ss <- s %>%
  unite("site_year", siteID, year, sep="@") %>%
  spread(site_year, percentage, fill = NA) 

# Fix column names and create additional row
nc <- ncol(ss)
tmp <- data.frame(nms = names(ss)[-1]) %>%
  tidyr::separate(nms, into=c("row1", "row2"), sep="@")
names(ss)[-1] <- tmp$row2
new_row <- paste(" & \\multicolumn{4}{c|}{",unique(tmp$row1),"}", 
                 collapse="")
new_row <- gsub("_", " ", new_row)
new_row <- paste(new_row, "\\\\", collapse=" ")

# Write table to file
tab <- ss %>%
  xtable(
    digits = 0,
    align = paste("rl|",paste(rep("rrrr|",floor(nc/4)),collapse=""),sep="",collapse=""),
    caption="Daubenmire: average land cover \\% across all rounds Caption 1234",
    label = "t:daubenmire") %>%
  print(
    # file = "include/daubenmire.tex",
    include.rownames = FALSE, 
    # NA.string="na",
    add.to.row = list(pos = list(-1), 
                      command = new_row),
    caption.placement = "top",
    size="\\small",
    # floating.environment = "sidewaystable",
    hline.after = c(-1,0,6),
    comment = FALSE
    ) 
```


```{r daubenmire_yearly_plot, dependson=c("daubenmire_yearly","palette"),fig.cap="Daubenmire figure caption"}
g_yearly <- ggplot(s, aes(year, percentage)) +
  geom_line() + 
  facet_grid(class ~ siteID, scales = "free_y") + 
  labs(x = "Year", y = "Mean Cover (%)") +
  theme_bw() + 
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle=90))

g_yearly
```


```{r daubenmire_yearly_plot_by_class, dependson=c("daubenmire_yearly","palette"), fig.height=8}
g_yearly_by_class <- ggplot(s, aes(year, percentage,
                   fill = class, 
                   # linetype = class, 
                   group = class)) +
  geom_area(color=NA) + 
  facet_grid(siteID ~ .) +
  labs(x = "Year", y = "Mean Cover (%)") +
  scale_fill_manual(values = class_col) +
  theme_bw() +
  theme(legend.position = "bottom", 
        axis.text.x = element_text(angle=90))

g_yearly_by_class
```


```{r daubenmire_write_plots, dependson=c("daubenmire_yearly_plot","daubenmire_yearly_plot_by_class")}
ggsave(filename = "include/daubenmire_yearly.png",
       plot = g_yearly,
       width = 6, 
       height = 4)

ggsave(filename = "include/daubenmire_yearly_by_class.png",
       plot = g_yearly_by_class,
       width = 6, 
       height = 6)
```


\clearpage
# Nectar


```{r nectar_data}
d <- nectar %>% 
  filter(siteID %in% sites) %>%
  select(siteID, year, month, `Nectar Plant Species`, count) %>%
  mutate(month = recode(month, `6` = "June", `7` = "July", `8` = "August"),
         month = factor(month, levels = c("June","July","August"))) %>%
  rename(common_name = `Nectar Plant Species`) %>%
  left_join(species, by="common_name") %>%
  rename(native = native_introduced_both) %>%
  mutate(native = recode(native, 
                         native     = "Native",
                         both       = "Introduced",
                         introduced = "Introduced"))
```


```{r nectar_yearly_data, dependson="nectar_data"}
s1 <- d %>% 
  group_by(year, siteID, month) %>%
  summarize(total = sum(count)) %>%
  mutate(native = "Combined")

s2 <- d %>% 
  group_by(year, siteID, month, native) %>%
  summarize(total = sum(count)) 

s_both <- bind_rows(s1,s2) %>%
  mutate(native = factor(native, levels = c("Combined","Native","Introduced")))
```


```{r nectar_yearly_plot, dependson="nectar_yearly_data",fig.cap="Nectar yearly caption"}
g <- ggplot(s_both , aes(year, total, 
              linetype = month, group = month, color = month)) +
  geom_line() + 
  facet_grid(native ~ siteID, scales="free_y") + 
  labs(x = "Year", y = "Inflorescence", linetype = "Month", color = "Month") +
  # scale_y_log10() +
  scale_color_manual(values = month_col) + 
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle=90))

g
```

```{r, nectar_write_plots, dependson="nectar_yearly_plot"}
ggsave(file = "include/nectar_yearly.png",
       plot = g,
       width = 6, 
       height = 4)
```



```{r, nectar_by_species, dependson="nectar_data"}
s <- d %>% 
  # filter(`Nectar Plant Species` != "white clover") %>%
  group_by(year, siteID, month, common_name, native) %>%
  summarize(total = sum(count))
  
# ggplot(s, aes(year, total, 
#               color = common_name,
#               linetype = native,
#               group = common_name)) +
#   geom_line() + 
#   facet_grid(siteID ~ month) + 
#   labs(x = "Year", y = "Inflorescence", linetype = "Species") +
#   scale_y_log10() + 
#   theme_bw() + 
#   theme(legend.position = "bottom")

ss <- s %>%
  group_by(year, siteID, common_name, native) %>%
  summarize(total = sum(total)) %>%
  spread(year, total, fill = 0) %>%
  mutate(log_ratio = log10(`2019`+1) - log10(`2018`+1) ,
         log_ratio = round(log_ratio)) %>% 
  arrange(native, log_ratio, common_name, siteID)

ss %>% write_csv("include/nectar_ratio.csv")
```



```{r, nectar_write_table, dependson="nectar_by_species"}
ss <- s %>%
  group_by(year, siteID, common_name, native) %>%
  summarize(density = mean(total)) %>%
  ungroup() %>%
  mutate(native = factor(native, levels=c("Native","Introduced"))) %>%
  
  # cra1 has a 70m transect, so adjust to 100m density
  mutate(density = ifelse(siteID == "cra1", density/.7, density)) %>%
  unite("site_year", siteID, year, sep="@") %>%
  spread(site_year, density, fill = NA) %>%
  arrange(native, common_name) %>%
  rename(`Common name` = "common_name")

n_native = sum(ss$native == "Native")
ss$native <- NULL

# Fix column names and create additional row
nc <- ncol(ss)
tmp <- data.frame(nms = names(ss)[-1]) %>%
  tidyr::separate(nms, into=c("row1", "row2"), sep="@")
names(ss)[-1] <- tmp$row2
new_row <- paste(" & \\multicolumn{4}{c|}{",unique(tmp$row1),"}", 
                 collapse="")
new_row <- gsub("_", " ", new_row)
new_row <- paste(new_row, "\\\\", collapse=" ")

tab <- ss %>%
  xtable(
    digits = 0,
    align = paste("rl|",paste(rep("rrrr|",floor(nc/4)),collapse=""),sep="",collapse=""),
    caption="Mean inflourescence (per 100m2) across all rounds. Species above the line are native and below the line are introduced.",
    label = "t:nectar") %>%
  print(
    # file = "include/nectar_yearly.tex",
    include.rownames = FALSE, 
    # NA.string="na",
    add.to.row = list(pos = list(-1), 
                      command = new_row),
    caption.placement = "top",
    size="\\small",
    # floating.environment = "sidewaystable",
    hline.after = c(-1,0,n_native,nrow(ss)),
    comment = FALSE
  ) 
```


\clearpage
# Monarch

```{r monarch_data}
d <- monarch %>% 
  filter(siteID %in% sites,
         type != "palmer amaranth") %>%
  mutate(month = recode(month, `6` = "June", `7` = "July", `8` = "August"),
         month = factor(month, levels = c("June","July","August"))) %>% 
  
  group_by(year, siteID, type, milkweed) %>%
  summarize(total = sum(count)) %>%
  ungroup() %>%
  
  # Create total columns
  mutate(type = recode(type, extra = "total", instar = "larvae")) %>%
  unite("type_milkweed", type, milkweed) %>%
  spread(type_milkweed, total, fill = 0) %>%
  mutate(total_NA = survey_NA + total_NA,
         eggs_NA   = eggs_NA   + eggs_common   + eggs_butterfly   + eggs_swamp,
         ramets_NA = ramets_NA + ramets_common + ramets_butterfly + ramets_swamp,
         larvae_NA = larvae_NA + larvae_common + larvae_butterfly + larvae_swamp) %>%
  gather("type_milkweed", "count", -year, -siteID) %>%
  separate(type_milkweed, c("type","milkweed"), sep="_") %>%
  
  mutate(
    milkweed = ifelse(type == "survey", "survey", milkweed),
    milkweed = ifelse(type == "total", "", milkweed),
    # milkweed = tools::toTitleCase(milkweed),
    milkweed = factor(milkweed, 
                      levels = c("butterfly","common","swamp","survey","total")),
    
    type = recode(type, survey = "adults", total = "adults"),
    type = tools::toTitleCase(type)) %>%
  unite("Monarch", type, milkweed, sep=", ") %>%
  mutate(
    Monarch = gsub(", NA", "", Monarch),
    Monarch = factor(Monarch, 
                     levels = c("Adults, survey", "Adults",
                                "Eggs, butterfly", "Eggs, common", "Eggs, swamp", "Eggs",
                                "Larvae, butterfly", "Larvae, common", "Larvae, swamp", "Larvae",
                                "Ramets, butterfly", "Ramets, common", "Ramets, swamp", "Ramets"))) 
```

```{r monarch_table, dependson="monarch_data"}
ss <- d %>%
  unite("site_year", siteID, year, sep="@") %>%
  spread(site_year, count, fill = NA) 
  


nc <- ncol(ss)
tmp <- data.frame(nms = names(ss)[-1]) %>%
  tidyr::separate(nms, into=c("row1", "row2"), sep="@")
names(ss)[-1] <- tmp$row2
new_row <- paste(" & \\multicolumn{4}{c|}{",unique(tmp$row1),"}", 
                 collapse="")
new_row <- gsub("_", " ", new_row)
new_row <- paste(new_row, "\\\\", collapse=" ")


ss %>%
  # spread(siteID, count) %>%
  # arrange(Monarch, year) %>% 
  xtable(
    digits = 0,
    align = paste("rl|",paste(rep("rrrr|",floor(nc/4)),collapse=""),sep="",collapse=""),
caption = "Bee table caption.") %>%
  print(
    # file = "monarch.tex",
    include.rownames = FALSE,
    add.to.row = list(pos = list(-1), command = new_row),
    hline.after = c(-1,0,2,6,10,14),
    comment = FALSE)
```

```{r monarch_plot, dependson="monarch_data",fig.cap="Monarch caption"}
g <- ggplot(d %>% filter(Monarch == "Adults, survey"), aes(year, count)) +
  geom_line() + 
  facet_grid(. ~ siteID, scales="free_y") + 
  labs(x = "Year", y = "Number of adult monarchs surveyed") +
  # scale_y_log10() + 
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle=90))
g
```

```{r write_monarch_plots, dependson="monarch_plot"}
ggsave(file = "include/monarch_yearly.png",
       plot = g,
       width = 6, 
       height = 4)
```



\clearpage

```{r bee_data}
d <- bee %>% 
  filter(siteID %in% sites) %>%
  mutate(month = recode(month, `6` = "June", `7` = "July", `8` = "August"),
         month = factor(month, levels = c("June","July","August"))) %>% 
  
  group_by(year, siteID, `Bee Species`) %>%
  summarize(total = sum(count)) %>%
  ungroup() %>%
  complete(year, siteID, `Bee Species`, fill = list(total = 0)) %>%
  rename(`Bee type` = `Bee Species`) %>%
  mutate(`Bee type` = sub(" bee"," ",`Bee type`))
```

```{r bee_table, dependson="bee_data"}
ss <- d %>%
  unite("site_year", siteID, year, sep="@") %>%
  spread(site_year, total, fill = NA) 


nc <- ncol(ss)
tmp <- data.frame(nms = names(ss)[-1]) %>%
  tidyr::separate(nms, into=c("row1", "row2"), sep="@")
names(ss)[-1] <- tmp$row2
new_row <- paste(" & \\multicolumn{4}{c|}{",unique(tmp$row1),"}", 
                 collapse="")
new_row <- gsub("_", " ", new_row)
new_row <- paste(new_row, "\\\\", collapse=" ")


ss %>%
  xtable(
    digits = 0,
    align = paste("rl|",paste(rep("rrrr|",floor(nc/4)),collapse=""),sep="",collapse=""),
    caption = "Bee table caption.") %>%
  print(
    # file = "include/bee_yearly.tex",
    add.to.row = list(pos = list(-1), command = new_row),
    include.rownames = FALSE,
    caption.placement = "top",
    comment = FALSE)
```

```{r bee_plot, dependson="bee_data",fig.cap="Bee figure caption"}
g <- ggplot(d, aes(year, total)) +
  geom_line() + 
  # geom_point() + 
  facet_grid(`Bee type` ~ siteID, scales="free_y") + 
  labs(x = "Year", y = "Number of bees") +
  # scale_y_log10() + 
  theme_bw() +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle=90))

g
```

```{r write_bee_plot, dependson="bee_plot"}
ggsave(file = "include/bee_yearly.png",
       plot = g,
       width = 6, 
       height = 4)
```
# Bee