---
title: "ISU Monarch Data Summary for NCIG"
author: "Jarad Niemi and Seth Appelgate"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{rotating}
  - \usepackage{caption} 
  - \captionsetup[table]{skip=10pt}
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{ISU Monarch Data Summary for NCIG}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, purl=FALSE, echo=FALSE}
library("knitr")
opts_chunk$set(echo    = FALSE, 
               results = 'asis',
               message = FALSE)
```

```{r packages}
suppressWarnings(library("tidyverse"))
library("ISUmonarch")
library("xtable")
options(xtable.comment = FALSE)
```

\setlength{\tabcolsep}{3pt}


```{r sites}

NCIG_sites = unique(transect$transectID)

```


Table \ref{t:nectar2016} and \ref{t:nectar2017} provide mean count of nectar plant species averaged across all 
data collection events. 
Table \ref{t:ramet2017} provides mean count of milkweed ramets.
Values in table represent the specific counting unit for each species, not necessarily a whole plant.
Table \ref{t:density2016} and \ref{t:density2017} provide nectar plant species density (per 100m2) averaged across all data collection events. 
Table \ref{t:density2017ramet} provides mean density of milkweed ramets.
Values in table represent the specific counting unit for each species, not necessarily a whole plant.

Table \ref{t:daubenmire} provides average land cover percentage averaged across 
all data collection events.

Table \ref{t:robel} provides average amount of vegetation across all data 
collection events.

Table \ref{t:monarch} provides total number of monarchs sighted anywhere around 
site during entire time at site, number of monarchs sighted during a survey 
period, number of milkweed ramets (an upper limit of 20 per round per site, 
although the same milkweed may have been surveyed in different rounds), 
number of monarch eggs counted on milkweed plants (if no milkweed present, 
no monarch eggs present, number of monarch larvae (caterpillars) counted on 
milkweed plants (if no milkweed present, no larvae present).

<!-- Table \ref{t:environment} provides a binary response of whether there were any  -->
<!-- flowering plants or milkweed present in the area around the site during any  -->
<!-- round. -->


<!-- Ramet -->

```{r ramet_table_function}
ramet_table <- function(yr, flt, label) {
  ramet %>%
    
    mutate(round = as.factor(round)) %>%
    
    filter(transectID %in% NCIG_sites, year == yr) %>%
    
    group_by(`Nectar Plant Species`, transectID, round) %>%
    summarize(count = sum(count)) %>%
    complete(transectID, round, fill = list(count = 0)) %>%
    group_by(`Nectar Plant Species`, transectID) %>%
    summarize(total = mean(count) %>% round(1)) %>%
    complete(transectID = NCIG_sites) %>%
    replace(.==0, NA) %>%
    tidyr::spread(transectID, total, fill=NA, drop=FALSE) %>%
    arrange(`Nectar Plant Species`) %>% 
    
    filter(`Nectar Plant Species` %in% flt) %>%
    
    xtable(digits = 1,
           caption=paste(yr, "nectar plant species: mean count across all surveys"),
           label = paste("t:",label,sep="")) %>%
    print(include.rownames = FALSE, NA.string="-", 
          table.placement = "p",
          caption.placement = "top",
          size="\\tiny",
          floating.environment = "sidewaystable") 
}
```

```{r ramet, warning=FALSE}
# ramet_table(yr=2016, flt=unique(ramet$`Nectar Plant Species`), label = "ramet2016")
ramet_table(yr=2017, flt=unique(ramet$`Nectar Plant Species`), label = "ramet2017")
ramet_table(yr=2018, flt=unique(ramet$`Nectar Plant Species`), label = "ramet2018")
```




\newpage



```{r ramet_density_table}
ramet_density_table <- function(yr, flt, label) {
ramet %>%
  mutate(`Nectar Plant Species` = 
           fct_recode(`Nectar Plant Species`,
                      smartweed = "swamp smartweed",
                      smartweed = "pennsylvania smartweed",
                      `culvers root` = "culver's root",
                      `shepherds purse` = "shepherd's purse",
                      `yellow sweet clover` = "yellow sweetclover"),
         year = as.character(year),
         round = as.factor(round)) %>% 
  
  filter(transectID %in% NCIG_sites, year == yr) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = NCIG_sites) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
    
  xtable(digits = 2,
           caption=paste(yr, "Nectar plant species density: average density (count / m2) across all rounds"),
           label=paste("t:",label,sep="")) %>%
    print(include.rownames = FALSE, NA.string="-", 
          table.placement = "p",
          caption.placement = "top",
          size="\\tiny",
          floating.environment = "sidewaystable") 
}
```

```{r ramet_density, warning=FALSE, message=FALSE}
# ramet_density_table(2016, c("butterfly milkweed ramet",
#                              "common milkweed ramet",
#                              "swamp milkweed ramet"),
#                      label = "density2016ramet")

ramet_density_table(yr=2017, flt=unique(ramet$`Nectar Plant Species`), label = "density2017ramet")
ramet_density_table(yr=2018, flt=unique(ramet$`Nectar Plant Species`), label = "density2018ramet")
```


```{r nectar_density_heatmap}
ramet_density_heatmap <- function(yr, flt) {
ramet %>%
  mutate(`Nectar Plant Species` = 
           fct_recode(`Nectar Plant Species`,
                      smartweed = "swamp smartweed",
                      smartweed = "pennsylvania smartweed",
                      `culvers root` = "culver's root",
                      `shepherds purse` = "shepherd's purse",
                      `yellow sweet clover` = "yellow sweetclover"),
         year = as.character(year),
         round = as.factor(round)) %>% 
  
  filter(transectID %in% NCIG_sites, year == yr) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = NCIG_sites) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
  
  gather(variable, value, -`Nectar Plant Species`) %>%
  
  ggplot(., aes(x=variable, y=`Nectar Plant Species`, z= value)) + 
  geom_tile(aes(fill = value), color="grey") + 
  theme_bw() + labs(x="", y="", fill="Log(Density)") +
  scale_fill_gradient(na.value = 'white', low="navy", high="salmon", trans="log") +
  theme(axis.text.x = element_text(angle = 90))
}
```

```{r ramet_heatmap, warning=FALSE, message=FALSE, fig.height=7, fig.width=9}
# ramet_density_heatmap(yr = 2016, flt = unique(ramet$`Nectar Plant Species`))
ramet_density_heatmap(yr = 2017, flt = unique(ramet$`Nectar Plant Species`))
ramet_density_heatmap(yr = 2018, flt = unique(ramet$`Nectar Plant Species`))
```




