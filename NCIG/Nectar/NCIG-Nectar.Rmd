---
title: "ISU Monarch Data Summary for NCIG"
author: "Jarad Niemi, Seth Appelgate, and Nehemias Ulloa"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{rotating}
  - \usepackage{caption} 
  - \captionsetup[table]{skip=10pt}
output: 
  pdf_document:
    fig_caption: TRUE
---

```{r setup, purl=FALSE, echo=FALSE}
library("knitr")
opts_chunk$set(echo    = FALSE, 
               results = 'asis',
               message = FALSE)
```

```{r packages}
suppressWarnings(library("tidyverse"))
library("ISUmonarch")
library("xtable")
options(xtable.comment = FALSE)
```

\setlength{\tabcolsep}{3pt}


```{r sites}

# NCIG_sites = c("all1", "all2", "app1", "arm1", 
#   "arm2", "bcr1", "bcr2", "ber1", "ber3", "byd1", "byd2", "cra1", 
#   "cre1", "dun2", "dun3", "fis1", "gro1", "gro2", "har1", "jon1", 
#   "nie1", "nkn1", "nkn2", "nor1", "pio1", "pio2", "prd1", "prd2", 
#   "pre1", "pre2", "pre3", "pre4", "sie1", "sut2", "tie1", "uth1", 
#   "uth2", "uth3", "van1", "van2", "ver1", "vos1")


# NCIG_sites = c("all1","all2","arm1","arm2","ber1","ber3","cre1","dun2","dun3",
#                "pio1","pio2","gro1","gro2","nkn1","nkn2","nor1","sut2",
#                "sie1","prd1","prd2","ver1")

NCIG_sites = unique(transect$transectID)

```


Table \ref{t:nectar2016} and \ref{t:nectar2017} provide mean count of nectar plant species averaged across all 
data collection events. 
Values in table represent the specific counting unit for each species, not necessarily a whole plant.
Table \ref{t:density2016} and \ref{t:density2017} provide nectar plant species density (per 100m2) averaged across all data collection events. 



<!-- Table \ref{t:environment} provides a binary response of whether there were any  -->
<!-- flowering plants or milkweed present in the area around the site during any  -->
<!-- round. -->


<!-- Nectar -->

```{r nectar_table_function}
nectar_table <- function(yr, flt, label) {
  nectar %>%
    
    mutate(round = as.factor(round)) %>%
    
    filter(transectID %in% NCIG_sites, year == yr) %>%
    
    group_by(`Nectar Plant Species`, transectID, round) %>%
    summarize(count = sum(count)) %>%
    complete(transectID, round, fill = list(count = 0)) %>%
    group_by(`Nectar Plant Species`, transectID) %>%
    summarize(total = mean(count) %>% round(1)) %>%
    complete(transectID = NCIG_sites) %>%
    replace(.==0, NA) %>%
    tidyr::spread(transectID, total, fill=NA, drop=FALSE) %>%
    arrange(`Nectar Plant Species`) %>% 
    
    filter(`Nectar Plant Species` %in% flt) %>%
    
    xtable(digits = 1,
           caption=paste(yr, "nectar plant species: mean count across all surveys"),
           label = paste("t:",label,sep="")) %>%
    print(include.rownames = FALSE, NA.string="-", 
          table.placement = "p",
          caption.placement = "top",
          size="\\small",
          floating.environment = "sidewaystable") 
}
```

```{r nectar, warning=FALSE}
nectar_table(2016, unique(nectar$`Nectar Plant Species`), 
             label = "nectar2016")
nectar_table(2017, unique(nectar$`Nectar Plant Species`), 
             label = "nectar2017")
nectar_table(2018, unique(nectar$`Nectar Plant Species`), 
             label = "nectar2018")

```




\newpage



```{r nectar_density_table}
nectar_density_table <- function(yr, flt, label) {
nectar %>%
  mutate(`Nectar Plant Species` = 
           fct_recode(`Nectar Plant Species`,
                      smartweed = "swamp smartweed",
                      smartweed = "pennsylvania smartweed",
                      `culvers root` = "culver's root",
                      `shepherds purse` = "shepherd's purse",
                      `yellow sweet clover` = "yellow sweetclover"),
         year = as.character(year),
         round = as.factor(round)) %>% 
  
  filter(transectID %in% NCIG_sites, year == yr) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = NCIG_sites) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
    
  xtable(digits = 2,
           caption=paste(yr, "Nectar plant species density: average density (count / m2) across all rounds"),
           label=paste("t:",label,sep="")) %>%
    print(include.rownames = FALSE, NA.string="-", 
          table.placement = "p",
          caption.placement = "top",
          size="\\small",
          floating.environment = "sidewaystable") 
}
```

```{r nectar_density, warning=FALSE, message=FALSE}
nectar_density_table(yr = 2016, flt = unique(nectar$`Nectar Plant Species`),
                     label = "density2016")
nectar_density_table(yr = 2017, flt = unique(nectar$`Nectar Plant Species`),
                     label = "density2017")
nectar_density_table(yr = 2018, flt = unique(nectar$`Nectar Plant Species`),
                     label = "density2018")
```


```{r nectar_density_heatmap}
# nectar_density_heatmap <- function(yr, flt) {
# nectar %>%
#   mutate(`Nectar Plant Species` = 
#            fct_recode(`Nectar Plant Species`,
#                       smartweed = "swamp smartweed",
#                       smartweed = "pennsylvania smartweed",
#                       `culvers root` = "culver's root",
#                       `shepherds purse` = "shepherd's purse",
#                       `yellow sweet clover` = "yellow sweetclover"),
#          year = as.character(year),
#          round = as.factor(round)) %>% 
#   
#   filter(transectID %in% NCIG_sites, year == yr) %>%
#   
#   left_join(subset(ISUmonarch::survey, year==yr) %>% 
#               mutate(round = as.factor(round)) %>%
#               select(transectID, length, round), by=c("transectID", "round")) %>%
#   
#   group_by(`Nectar Plant Species`, transectID, round) %>%
#   summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
#   complete(transectID, round, fill = list(density = 0)) %>%
#   
#   group_by(`Nectar Plant Species`, transectID) %>%
#   summarize(density = mean(density, na.rm=TRUE)) %>%
#   
#   complete(transectID = NCIG_sites) %>%
#   ungroup() %>% 
#   select(`Nectar Plant Species`, transectID, density) %>%
#   replace(.==0, NA) %>%
#   tidyr::spread(transectID, density, fill=NA) %>%
#   arrange(`Nectar Plant Species`) %>% 
#   
#   filter(`Nectar Plant Species` %in% flt) %>%
#   
#   gather(variable, value, -`Nectar Plant Species`) %>%
#   
#   ggplot(., aes(x=variable, y=`Nectar Plant Species`, z= value)) + 
#   geom_tile(aes(fill = value), color="grey") + 
#   theme_bw() + labs(x="", y="", fill="Log(Density)") +
#   scale_fill_gradient(na.value = 'white', low="navy", high="salmon", trans="log") +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
# }
```


```{r nectar_density_heatmap2}
NCIG_sites = unique(transect$transectID)

nectar_density_heatmap2 <- function(yr, flt, plnt="planted") {

tmp=nectar %>%
  mutate(year = as.character(year),
         round = as.factor(round)) %>% 
  
  left_join(species[,c("common_name", "planted_non_planted")], by=c("Nectar Plant Species"="common_name")) %>%
    
  filter(transectID %in% NCIG_sites, year %in% yr, planted_non_planted %in% plnt) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = NCIG_sites) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
  
  gather(variable, value, -`Nectar Plant Species`) %>%
  
  mutate(presence = ifelse(is.na(value), 0, 1))
  
  tran.order = tmp %>% group_by(variable) %>% summarise(avg.density = mean(value, na.rm=TRUE)) %>% arrange(desc(avg.density)) %>% select(variable) %>% pull(variable)
  
  # species.order = tmp %>% group_by(`Nectar Plant Species`) %>% summarise(avg.density = mean(value, na.rm=TRUE)) %>% arrange(avg.density) %>% select(`Nectar Plant Species`) %>% pull(`Nectar Plant Species`)
  
  species.order = tmp %>% group_by(`Nectar Plant Species`) %>% summarise(avg.density = mean(presence, na.rm=TRUE)) %>% arrange(avg.density) %>% select(`Nectar Plant Species`) %>% pull(`Nectar Plant Species`)

  tmp$variable <- factor(tmp$variable, levels = tran.order)
  tmp$`Nectar Plant Species` <- factor(tmp$`Nectar Plant Species`, levels = species.order)
  
  ggplot(tmp, aes(x=variable, y=`Nectar Plant Species`, z= value)) + 
  geom_tile(aes(fill = value), color="grey") + 
  theme_bw() + labs(x="", y="", fill="Log(Density)") +
  scale_fill_gradient(na.value = 'white', low="navy", high="salmon", trans="log") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) + 
  scale_x_discrete(position = "top") +
  theme(axis.text.x.top = element_text(vjust = 0.5))
}
```

Here are some heatmaps for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence.


```{r nectar_heatmap_16, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species planted and non-planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2016."}
nectar_density_heatmap2(yr = 2016, flt = unique(nectar$`Nectar Plant Species`), plnt=c("planted", "non planted"))
```


```{r nectar_heatmap_17, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species planted and non-planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2017."}
nectar_density_heatmap2(yr = 2017, flt = unique(nectar$`Nectar Plant Species`), plnt=c("planted", "non planted"))
```


```{r nectar_heatmap_18, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species planted and non-planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2018."}
nectar_density_heatmap2(yr = 2018, flt = unique(nectar$`Nectar Plant Species`), plnt=c("planted", "non planted"))
```




```{r nectar_heatmap2_planted_16, warning=FALSE, message=FALSE, fig.height=5, fig.width=9, fig.cap="This plot is a heatmap for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2016."}
nectar_density_heatmap2(yr = 2016, flt = unique(nectar$`Nectar Plant Species`), plnt="planted")
```


```{r nectar_heatmap2_planted_17, warning=FALSE, message=FALSE, fig.height=6, fig.width=9, fig.cap="This plot is a heatmap for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2017."}
nectar_density_heatmap2(yr = 2017, flt = unique(nectar$`Nectar Plant Species`), plnt="planted")
```


```{r nectar_heatmap2_planted_18, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.cap="This plot is a heatmap for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2018."}
nectar_density_heatmap2(yr = 2018, flt = unique(nectar$`Nectar Plant Species`), plnt="planted")
```


```{r nectar_heatmap2_non_planted_16, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species non planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2016."}
nectar_density_heatmap2(yr = 2016, flt = unique(nectar$`Nectar Plant Species`), plnt="non planted")
```


```{r nectar_heatmap2_non_planted_17, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species non planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2017."}
nectar_density_heatmap2(yr = 2017, flt = unique(nectar$`Nectar Plant Species`), plnt="non planted")
```


```{r nectar_heatmap2_non_planted_18, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species non planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2018."}
nectar_density_heatmap2(yr = 2018, flt = unique(nectar$`Nectar Plant Species`), plnt="non planted")
```




```{r nectar_binary_heatmap}
NCIG_sites = unique(transect$transectID)

nectar_binary_heatmap <- function(yr, flt, plnt="planted") {

tmp=nectar %>%
  mutate(year = as.character(year),
         round = as.factor(round)) %>% 
  
  left_join(species[,c("common_name", "planted_non_planted")], by=c("Nectar Plant Species"="common_name")) %>%
    
  filter(transectID %in% NCIG_sites, year == yr, planted_non_planted == plnt) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = NCIG_sites) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
  
  gather(variable, value, -`Nectar Plant Species`) %>%
  
  mutate(presence = ifelse(is.na(value), 0, 1)) %>%
  
  select(everything(), -value)
  
  tran.order = tmp %>% group_by(variable) %>% summarise(avg.density = mean(presence, na.rm=TRUE)) %>% arrange(desc(avg.density)) %>% select(variable) %>% pull(variable)
  
  species.order = tmp %>% group_by(`Nectar Plant Species`) %>% summarise(avg.density = mean(presence, na.rm=TRUE)) %>% arrange(avg.density) %>% select(`Nectar Plant Species`) %>% pull(`Nectar Plant Species`)

  tmp$variable <- factor(tmp$variable, levels = tran.order)
  tmp$`Nectar Plant Species` <- factor(tmp$`Nectar Plant Species`, levels = species.order)
  
  ggplot(tmp, aes(x=variable, y=`Nectar Plant Species`, z= factor(presence))) + 
  geom_tile(aes(fill =factor(presence)), color="grey") + 
  theme_bw() + labs(x="", y="", fill="Presence") +
  scale_colour_manual(values = c("white", "navy"),
    aesthetics = c("colour", "fill")) + 
  # scale_fill_gradient(na.value = 'white', low="navy", high="salmon") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) + 
  scale_x_discrete(position = "top") 
}
```


<!-- Binary heatmaps for density of species planted. -->
<!-- \newpage -->
<!-- ```{r nectar_binary_planted, warning=FALSE, message=FALSE, fig.height=9, fig.width=9} -->
<!-- nectar_binary_heatmap(yr = 2016, flt = unique(nectar$`Nectar Plant Species`), plnt="planted") -->
<!-- nectar_binary_heatmap(yr = 2017, flt = unique(nectar$`Nectar Plant Species`), plnt="planted") -->
<!-- nectar_binary_heatmap(yr = 2018, flt = unique(nectar$`Nectar Plant Species`), plnt="planted") -->
<!-- ``` -->


<!-- Binary heatmaps for density of species non planted. -->
<!-- \newpage -->
<!-- ```{r nectar_binary_non_planted, warning=FALSE, message=FALSE, fig.height=9, fig.width=9} -->
<!-- nectar_binary_heatmap(yr = 2016, flt = unique(nectar$`Nectar Plant Species`), plnt="non planted") -->
<!-- nectar_binary_heatmap(yr = 2017, flt = unique(nectar$`Nectar Plant Species`), plnt="non planted") -->
<!-- nectar_binary_heatmap(yr = 2018, flt = unique(nectar$`Nectar Plant Species`), plnt="non planted") -->
<!-- ``` -->



