---
title: "ISU Monarch Data Summary for NCIG"
author: "Jarad Niemi, Seth Appelgate, and Nehemias Ulloa"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{rotating}
  - \usepackage{caption} 
  - \captionsetup[table]{skip=10pt}
output: 
  pdf_document:
    fig_caption: TRUE
---

```{r setup, purl=FALSE, echo=FALSE}
library("knitr")
opts_chunk$set(echo    = FALSE, 
               results = 'asis',
               message = FALSE)
```

```{r packages}
suppressWarnings(library("tidyverse"))
library("ISUmonarch")
library("xtable")
options(xtable.comment = FALSE)
```

\setlength{\tabcolsep}{3pt}


```{r species}
species = unique(nectar$`Nectar Plant Species`)
species = species[order(species)]
flt1 = species[1:floor(length(species)/2)]
flt2 = species[-c(1:floor(length(species)/2))]
```



```{r sites}
NCIG_transects = as.character(unique(transect$transectID))
NCIG_transects = as.character(unique(NCIG_transects[!(NCIG_transects %in% c("tuth1a", "tuth2a", "tsie1a"))]))
NCIG_transects = NCIG_transects[order(NCIG_transects)]



chunk <- function(x,n) split(x, cut(seq_along(x), n, labels = FALSE)) 
splits = chunk(NCIG_transects, 3)

transects1 = splits[[1]]
transects2 = splits[[2]]
transects3 = splits[[3]]
```


Table \ref{t:nectar2016} and \ref{t:nectar2017} provide mean count of nectar plant species averaged across all 
data collection events. 
Values in table represent the specific counting unit for each species, not necessarily a whole plant.
Table \ref{t:density2016} and \ref{t:density2017} provide nectar plant species density (per 100m2) averaged across all data collection events. 



<!-- Nectar -->

```{r nectar_table_function}
nectar_table <- function(yr, flt, transects, label) {
  nectar %>%
    
    mutate(round = as.factor(round)) %>%
    
    filter(transectID %in% transects, year == yr) %>%
    
    group_by(`Nectar Plant Species`, transectID, round) %>%
    summarize(count = sum(count)) %>%
    complete(transectID, round, fill = list(count = 0)) %>%
    group_by(`Nectar Plant Species`, transectID) %>%
    summarize(total = mean(count) %>% round(1)) %>%
    complete(transectID = transects) %>%
    replace(.==0, NA) %>%
    tidyr::spread(transectID, total, fill=NA, drop=FALSE) %>%
    arrange(`Nectar Plant Species`) %>% 
    
    filter(`Nectar Plant Species` %in% flt) %>%
    
    xtable(digits = 1,
           caption=paste(yr, "nectar plant species: mean count across all surveys"),
           label = paste("t:",label,sep="")) %>%
    print(include.rownames = FALSE, 
          NA.string="-", 
          # rotate.colnames = TRUE,
          table.placement = "p",
          caption.placement = "top",
          size="\\small",
          floating.environment = "sidewaystable") 
}
```

```{r nectar, warning=FALSE}
nectar_table(yr=2016, 
             flt=species,
             transects = transects1,
             label = "nectar2016a")
nectar_table(yr=2016, 
             flt=species,
             transects = transects2,
             label = "nectar2016b")
nectar_table(yr=2016, 
             flt=species,
             transects = transects3,
             label = "nectar2016c")
nectar_table(yr=2017, 
             flt=unique(nectar$`Nectar Plant Species`), 
             transects = NCIG_transects,
             label = "nectar2017")
nectar_table(yr=2018, 
             flt=unique(nectar$`Nectar Plant Species`), 
             transects = NCIG_transects,
             label = "nectar2018")

```




\newpage



```{r nectar_density_table}
nectar_density_table <- function(yr, flt, transects, label) {
nectar %>%
  mutate(`Nectar Plant Species` = 
           fct_recode(`Nectar Plant Species`,
                      smartweed = "swamp smartweed",
                      smartweed = "pennsylvania smartweed",
                      `culvers root` = "culver's root",
                      `shepherds purse` = "shepherd's purse",
                      `yellow sweet clover` = "yellow sweetclover"),
         year = as.character(year),
         round = as.factor(round)) %>% 
  
  filter(transectID %in% transects, year == yr) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = transects) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
    
  xtable(digits = 2,
           caption=paste(yr, "Nectar plant species density: average density (count / m2) across all rounds"),
           label=paste("t:",label,sep="")) %>%
    print(include.rownames = FALSE, 
          NA.string="-", 
          # rotate.colnames = TRUE,
          table.placement = "p",
          caption.placement = "top",
          size="\\small",
          floating.environment = "sidewaystable") 
}
```

```{r nectar_density, warning=FALSE, message=FALSE}
nectar_density_table(yr = 2016, 
                     flt = unique(nectar$`Nectar Plant Species`),
                     transects = NCIG_transects,
                     label = "density2016")
nectar_density_table(yr = 2017, 
                     flt = unique(nectar$`Nectar Plant Species`),
                     transects = NCIG_transects,
                     label = "density2017")
nectar_density_table(yr = 2018, 
                     flt = unique(nectar$`Nectar Plant Species`),
                     transects = NCIG_transects,
                     label = "density2018")
```


```{r nectar_density_heatmap}
nectar_density_heatmap <- function(yr, flt, transects, plnt="planted") {

tmp=nectar %>%
  mutate(year = as.character(year),
         round = as.factor(round)) %>% 
  
  left_join(ISUmonarch::species[,c("common_name", "planted_non_planted")], by=c("Nectar Plant Species"="common_name")) %>%
    
  filter(transectID %in% transects, year %in% yr, planted_non_planted %in% plnt) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = transects) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
  
  gather(variable, value, -`Nectar Plant Species`) %>%
  
  mutate(presence = ifelse(is.na(value), 0, 1))
  
  tran.order = tmp %>% group_by(variable) %>% summarise(avg.density = mean(value, na.rm=TRUE)) %>% arrange(desc(avg.density)) %>% select(variable) %>% pull(variable)
  
  # species.order = tmp %>% group_by(`Nectar Plant Species`) %>% summarise(avg.density = mean(value, na.rm=TRUE)) %>% arrange(avg.density) %>% select(`Nectar Plant Species`) %>% pull(`Nectar Plant Species`)
  
  species.order = tmp %>% group_by(`Nectar Plant Species`) %>% summarise(avg.density = mean(presence, na.rm=TRUE)) %>% arrange(avg.density) %>% select(`Nectar Plant Species`) %>% pull(`Nectar Plant Species`)

  tmp$variable <- factor(tmp$variable, levels = tran.order)
  tmp$`Nectar Plant Species` <- factor(tmp$`Nectar Plant Species`, levels = species.order)
  
  ggplot(tmp, aes(x=variable, y=`Nectar Plant Species`, z= value)) + 
  geom_tile(aes(fill = value), color="grey") + 
  theme_bw() + labs(x="", y="", fill="Log(Density)") +
  scale_fill_gradient(na.value = 'white', low="navy", high="salmon", trans="log") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) + 
  scale_x_discrete(position = "top") +
  theme(axis.text.x.top = element_text(vjust = 0.5))
}
```

Here are some heatmaps for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence.


```{r nectar_heatmap_16, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species planted and non-planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2016."}
nectar_density_heatmap(yr = 2016, 
                       flt = species, 
                       transects = NCIG_transects, 
                       plnt=c("planted", "non planted"))
```


```{r nectar_heatmap_17, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species planted and non-planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2017."}
nectar_density_heatmap(yr = 2017, 
                       flt = species, 
                       transects = NCIG_transects, 
                       plnt=c("planted", "non planted"))
```


```{r nectar_heatmap_18, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species planted and non-planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2018."}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a", "tfis1a"))]))
nectar_density_heatmap(yr = 2018, 
                       flt = species, 
                       transects = NCIG_transects[!(NCIG_transects %in% c("tuth1a","tuth2a","tsie1a","tfis1a"))],
                       plnt=c("planted", "non planted"))
```




```{r nectar_heatmap2_planted_16, warning=FALSE, message=FALSE, fig.height=5, fig.width=9, fig.cap="This plot is a heatmap for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2016."}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a"))]))
nectar_density_heatmap(yr = 2016, 
                       flt = species, 
                       transects = NCIG_transects,
                       plnt=c("planted"))
```


```{r nectar_heatmap2_planted_17, warning=FALSE, message=FALSE, fig.height=6, fig.width=9, fig.cap="This plot is a heatmap for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by avg presence for year 2017."}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a"))]))
nectar_density_heatmap(yr = 2017, 
                       flt = species, 
                       transects = NCIG_transects,
                       plnt=c("planted"))
```


```{r nectar_heatmap2_planted_18, warning=FALSE, message=FALSE, fig.height=7, fig.width=9, fig.cap="This plot is a heatmap for density of species planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2018."}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a", "tfis1a"))]))
nectar_density_heatmap(yr = 2018,
                       flt = species, 
                       transects = NCIG_transects[!(NCIG_transects %in% c("tuth1a","tuth2a","tsie1a","tfis1a"))],
                       plnt=c("planted"))
```


```{r nectar_heatmap2_non_planted_16, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species non planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2016."}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a"))]))
nectar_density_heatmap(yr = 2016, 
                       flt = species, 
                       transects = NCIG_transects,
                       plnt=c("non planted"))
```


```{r nectar_heatmap2_non_planted_17, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species non planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2017."}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a"))]))
nectar_density_heatmap(yr = 2017, 
                       flt = species, 
                       transects = NCIG_transects,
                       plnt=c("non planted"))
```


```{r nectar_heatmap2_non_planted_18, warning=FALSE, message=FALSE, fig.height=9, fig.width=9, fig.cap="This plot is a heatmap for density of species non planted with transects on the columns and species on the rows sorting transects by average density and sorting species by average presence for year 2018."}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a", "tfis1a"))]))
nectar_density_heatmap(yr = 2018, 
                       flt = species, 
                       transects = NCIG_transects[!(NCIG_transects %in% c("tuth1a","tuth2a","tsie1a","tfis1a"))],
                       plnt=c("non planted"))
```




```{r nectar_binary_heatmap}
# NCIG_sites = as.character(unique(transect$transectID))
# NCIG_sites = as.character(unique(NCIG_sites[!(NCIG_sites %in% c("tuth1a", "tuth2a", "tsie1a"))]))

nectar_binary_heatmap <- function(yr, flt, plnt="planted") {

tmp=nectar %>%
  mutate(year = as.character(year),
         round = as.factor(round)) %>% 
  
  left_join(species[,c("common_name", "planted_non_planted")], by=c("Nectar Plant Species"="common_name")) %>%
    
  filter(transectID %in% NCIG_sites, year == yr, planted_non_planted == plnt) %>%
  
  left_join(subset(ISUmonarch::survey, year==yr) %>% 
              mutate(round = as.factor(round)) %>%
              select(transectID, length, round), by=c("transectID", "round")) %>%
  
  group_by(`Nectar Plant Species`, transectID, round) %>%
  summarize(density = sum(count, na.rm=TRUE)/as.numeric(unique(length))) %>%
  complete(transectID, round, fill = list(density = 0)) %>%
  
  group_by(`Nectar Plant Species`, transectID) %>%
  summarize(density = mean(density, na.rm=TRUE)) %>%
  
  complete(transectID = NCIG_sites) %>%
  ungroup() %>% 
  select(`Nectar Plant Species`, transectID, density) %>%
  replace(.==0, NA) %>%
  tidyr::spread(transectID, density, fill=NA) %>%
  arrange(`Nectar Plant Species`) %>% 
  
  filter(`Nectar Plant Species` %in% flt) %>%
  
  gather(variable, value, -`Nectar Plant Species`) %>%
  
  mutate(presence = ifelse(is.na(value), 0, 1)) %>%
  
  select(everything(), -value)
  
  tran.order = tmp %>% group_by(variable) %>% summarise(avg.density = mean(presence, na.rm=TRUE)) %>% arrange(desc(avg.density)) %>% select(variable) %>% pull(variable)
  
  species.order = tmp %>% group_by(`Nectar Plant Species`) %>% summarise(avg.density = mean(presence, na.rm=TRUE)) %>% arrange(avg.density) %>% select(`Nectar Plant Species`) %>% pull(`Nectar Plant Species`)

  tmp$variable <- factor(tmp$variable, levels = tran.order)
  tmp$`Nectar Plant Species` <- factor(tmp$`Nectar Plant Species`, levels = species.order)
  
  ggplot(tmp, aes(x=variable, y=`Nectar Plant Species`, z= factor(presence))) + 
  geom_tile(aes(fill =factor(presence)), color="grey") + 
  theme_bw() + labs(x="", y="", fill="Presence") +
  scale_colour_manual(values = c("white", "navy"),
    aesthetics = c("colour", "fill")) + 
  # scale_fill_gradient(na.value = 'white', low="navy", high="salmon") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) + 
  scale_x_discrete(position = "top") 
}
```





